# 量化建模标签策略研究报告

## 摘要

本报告深入分析了量化交易中GMMHMM标签器的设计问题，解释了为什么"更准确"的标签（gmm_labeler_v2）反而导致更差的回测结果，而"不完美"的标签（gmm_labeler）却能产生可交易的信号。核心结论是：**标签的价值在于其可学习性和可操作性，而非对市场"真实状态"的忠实度**。

---

## 1. 问题背景

### 1.1 两种标签器的对比

| 特性 | gmm_labeler (V1) | gmm_labeler_v2 (V2) |
|------|------------------|---------------------|
| **聚类特征** | `[HL_diff, log_return_L, log_return]` | `[hl_diff, ret_lag, ret_1, fwd_ret_lag]` |
| **是否使用未来信息** | ❌ 否 | ✅ 是 (`fwd_ret_lag`) |
| **协方差类型** | `diag` | `full` |
| **初始化方式** | Optuna搜索最优random_state | 基于未来收益方向初始化 |
| **目标函数** | 最大化 Σ|state_return| | 无显式优化目标 |

### 1.2 观察到的悖论

- **V2**: 模型指标优秀（F1 > 0.9, R² > 0.9），但回测结果糟糕
- **V1**: 模型指标一般（F1 = 0.5-0.7, R² = 0.0-0.7），但回测效果更好

---

## 2. 核心理论分析

### 2.1 标签的两种设计范式

```
┌─────────────────────────────────────────────────────────────────┐
│                      标签设计的两种范式                           │
├─────────────────────────────────────────────────────────────────┤
│  V1: 预测性建模 (Predictive)      │  V2: 描述性建模 (Descriptive) │
│  ────────────────────────────────│────────────────────────────── │
│  目标: 找到可操作的状态            │  目标: 找到"真实"的市场状态    │
│  约束: 必须从历史特征可识别        │  约束: 无（使用未来信息）       │
│  结果: 不完美但可学习             │  结果: 完美但不可学习           │
│  交易价值: 高                     │  交易价值: 零                  │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 Bayes Error 视角

**核心概念**: 给定特征集X，预测标签Y的最优误差称为Bayes Error。

- **V1标签**: 是历史特征的函数，因此 `Bayes Error(Y_v1 | X_historical)` **低** → 可学习
- **V2标签**: 依赖未来信息，因此 `Bayes Error(Y_v2 | X_historical)` **高** → 本质上不可学习

即使ML模型在V2上获得高F1，这也是**虚假相关性**的结果：模型过拟合了样本内未来信息与历史噪声之间的偶然相关，这些相关在样本外不存在。

### 2.3 σ-代数与因果可识别性

从测度论视角：
> 标签必须相对于可用特征生成的σ-代数是**可测的**

V2标签违反了这个原则——它们是基于未来信息定义的，因此对于只能观测历史的交易系统来说是**不可识别的目标**。

### 2.4 决策论视角

> **"信息的价值在于它对决策的影响，而非对真相的忠实度"**

V1本质上是一种**直接策略学习(Direct Policy Learning)**：它不是试图恢复"真实"的市场状态，而是找到：
1. 可以从历史特征识别的状态
2. 具有不同期望收益的状态

这种"可操作但不完美"的状态比"真实但不可学习"的状态具有更高的交易价值。

---

## 3. V1设计的智慧

### 3.1 目标函数分析

V1使用Optuna最大化 `Σ|state_return|`，这实际上是：

1. **Fisher可分性准则的无监督版本**: 寻找使类间差异最大化的聚类
2. **信噪比优化**: 不是优化重构精度，而是优化状态间的收益差异
3. **自一致性**: 标签由历史特征定义，因此历史特征天然能预测这些标签

### 3.2 为什么"不完美"是优势

| 特性 | 含义 |
|------|------|
| 低F1/R² | 标签有噪声，但这些噪声是**可学习的**噪声 |
| 基于历史聚类 | 标签与可观测特征有因果关系 |
| 收益分离优化 | 状态具有实际的交易含义（多头/空头） |

---

## 4. 自定义轴的评估准则

### 4.1 三种检验的关系

| 检验 | 测试内容 | 解释 |
|------|----------|------|
| **Hurst指数** | 长期记忆/持续性 | H>0.5趋势性, H<0.5均值回归, H≈0.5随机游走 |
| **ADF检验** | 单位根（平稳性） | 拒绝原假设 → 平稳 |
| **KPSS检验** | 平稳性（单位根） | 拒绝原假设 → 非平稳 |

**关键理解**: ADF和KPSS是**互补**的，不是重复的：
- ADF的原假设是"存在单位根"（非平稳）
- KPSS的原假设是"平稳"
- 两者一起使用可以提供更可靠的判断

### 4.2 检验结果的解读

| ADF | KPSS | 结论 |
|-----|------|------|
| 拒绝 | 不拒绝 | 强证据：**平稳** |
| 不拒绝 | 拒绝 | 强证据：**非平稳** |
| 都拒绝 | - | 边界情况，需进一步分析 |
| 都不拒绝 | - | 边界情况，需进一步分析 |

### 4.3 对于趋势跟踪策略的优先级

1. **Hurst指数优先**: 稳定的H>0.5表明序列具有可交易的持续性
2. **ADF/KPSS辅助**: 主要用于决定是否需要差分/去趋势

### 4.4 看似矛盾的结果解释

**问题**: 如果Hurst>0.5但ADF拒绝（平稳），这矛盾吗？

**答案**: 不矛盾！可以存在**平稳但正自相关**的序列：
- 短期内有持续性（trending locally）
- 但长期会回归到均值（no unit root）
- 这种序列对趋势跟踪策略是有价值的

---

## 5. 自定义轴（Custom Bars）的设计原则

### 5.1 统一理论框架：轴设计与标签设计的交互

> **核心洞见**：轴设计和标签设计**共同决定**系统的可学习性。
>
> - **轴设计**塑造了条件特征分布 `p(X_t | regime)`
> - **标签设计**标记这些regime
> - **分类器的可达误差**由两者共同决定的重叠程度决定

```
┌─────────────────────────────────────────────────────────────────┐
│                  轴设计 ↔ 标签设计 统一框架                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  原始K线 ──→ 自定义轴 ──→ 特征分布 ──→ Regime分离度               │
│              (Bar设计)    p(X|regime)    (Bayes Error)           │
│                  ↓                           ↓                   │
│              低Kurtosis                  可学习的标签              │
│              适度Hurst                   高交易价值               │
│              通过ADF/KPSS                                        │
│                                                                  │
│  关键：好的轴 = 增加regime分离度 = 降低Bayes Error = 更可学习     │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 DemoBar vs DemoV2Bar 对比分析

| 特性 | DemoBar (V1) | DemoV2Bar (V2) |
|------|--------------|----------------|
| **公式** | `abs(close - close_lag1) * (high - low) / close` | `abs(ln(close/close_lag1)) * ln(high/low) * 10000` |
| **数学本质** | 线性组合 | 对数组合 |
| **量纲** | 价格单位 | 无量纲（对数收益率） |
| **对称性** | 涨跌不对称 | 涨跌对称 |
| **尾部处理** | 无 | clip_r过滤小值 |

#### 为什么V2更优？

1. **对数变换的优势**：
   - 归一化乘法性价格变动
   - 对称化上涨/下跌冲击
   - 减少尺度漂移，使方差跨regime更稳定

2. **Clip机制**：
   - 过滤微小波动（噪声）
   - 减少尾部杠杆效应
   - 聚焦于有意义的价格运动

### 5.3 优化目标：为什么最小化Kurtosis？

**目标函数**：`minimize Kurtosis(log_returns)` + 约束（bar数量 ≥ 4小时K线数量）

| Kurtosis | 含义 | 对ML的影响 |
|----------|------|-----------|
| 高 (>3) | 厚尾分布，极端值多 | 模型过度反应异常值，决策边界不稳定 |
| ≈3 | 接近正态分布 | 协方差结构稳定，mixture分离更清晰 |
| 低 (<3) | 薄尾分布 | 方差稳定，泛化能力强 |

**低Kurtosis的好处**：
- 减少标签噪声
- 稳定方差结构
- 改善mixture分量的分离度
- 使regime边界足够平稳以便学习

### 5.4 Hurst指数的最优范围

| Hurst范围 | 含义 | 对trading的影响 |
|-----------|------|----------------|
| H < 0.5 | 均值回归 | 适合反转策略，不适合趋势跟踪 |
| H ≈ 0.5 | 随机游走 | 无可预测模式，不适合任何策略 |
| **0.55-0.7** | **适度持续性** | **最佳区间：足够的趋势性，但不过度脆弱** |
| H > 0.8 | 极强趋势性 | 可能表明regime脆弱，过拟合风险高 |

**为什么适度Hurst最好？**
- 足够的持续性让HMM能检测到自相关的emission序列
- 避免近单位根脆弱性（会模糊regime边界）
- 平衡可预测性与稳定性

### 5.5 ADF/KPSS在轴评估中的作用

**核心作用**：确保emission参数随时间稳定，减少concept drift

| 检验 | 对轴设计的意义 |
|------|---------------|
| ADF不拒绝 + KPSS拒绝 | 非平稳，价格持续偏离均值 → 适合趋势跟踪 |
| ADF拒绝 + KPSS不拒绝 | 平稳，价格围绕均值波动 → 适合均值回归 |
| 矛盾结果 | 边界情况，需结合Hurst判断 |

**实践建议**：
- 对于趋势跟踪策略，优先看Hurst
- ADF/KPSS主要用于决定是否需要差分/去趋势预处理
- 矛盾结果时，以Hurst为主要参考

### 5.6 可学习自定义轴的完整检查清单

✅ **必须满足**：
1. log return的Kurtosis接近3（正态分布）
2. Hurst在0.55-0.7之间（适度持续性）
3. 足够的bar数量（不低于4小时K线数量）

⚠️ **建议满足**：
4. 通过ADF/KPSS联合检验（结论一致）
5. 时间间隔分布合理（无极端聚集）
6. 波动率跨时间稳定

❌ **应避免**：
7. 极高Kurtosis（>6）：尾部风险过大
8. Hurst过高（>0.8）：regime可能脆弱
9. bar数量过少：样本不足以学习

---

## 6. 改进建议

### 6.1 特征增强

在GMMHMM聚类中加入更多与regime相关的历史特征：
- 滚动波动率 (rolling volatility)
- 已实现偏度/峰度 (realized skew/kurtosis)
- 短/中期动量 (momentum at different scales)
- 成交量/流动性代理 (volume/illiquidity proxies)

### 6.2 目标函数优化

将目标函数从简单的收益分离改为：
```
目标 = Sharpe(state_returns) - λ × turnover_penalty
```
即：优化状态条件收益的夏普比率，同时惩罚频繁状态切换

### 6.3 正则化

- 使用Dirichlet先验约束转移矩阵
- 设置最小驻留时间 (minimum dwell time)
- 使用rolling/walk-forward验证避免过拟合

### 6.4 应避免的做法

| 做法 | 原因 |
|------|------|
| 使用任何未来信息作为聚类特征 | 即使是"软约束"也会造成泄露 |
| 过度追求指标（F1/R²） | 高指标可能是过拟合的信号 |
| 频繁调整lag_n等超参数 | 容易造成hyperparameter fishing |

---

## 7. 结论

### 7.1 核心发现

1. **标签可学习性 > 标签准确性**: 在量化交易中，标签必须能够从历史特征学习。使用未来信息定义的"完美"标签，如果无法用历史特征预测，则毫无交易价值。

2. **V1的设计哲学是正确的**: 通过最大化状态间收益分离，V1找到了"可操作的"而非"真实的"市场状态。这种方法虽然在模型指标上表现一般，但在实际交易中更有效。

3. **V2的高指标是虚假的**: 高F1/R²来自模型对样本内虚假相关性的过拟合，这些相关性在样本外不存在。

### 7.2 自定义轴的构建准则

1. **优先看Hurst指数**: H>0.5表明序列具有趋势跟踪的可交易性
2. **ADF+KPSS联合判断平稳性**: 用于决定预处理策略
3. **log return分布接近正态**: 有助于模型假设的有效性

### 7.3 未来研究方向

1. 探索更丰富的历史特征组合
2. 设计基于Sharpe ratio的聚类目标函数
3. 研究多尺度一致性约束
4. 开发更严格的walk-forward验证框架

---

## 附录：理论框架总结

```
┌─────────────────────────────────────────────────────────────────┐
│                       理论框架速查表                              │
├─────────────────────────────────────────────────────────────────┤
│ 概念                 │ 含义                                      │
│ ──────────────────── │ ───────────────────────────────────────── │
│ Bayes Error          │ 给定特征的最优预测误差                      │
│ σ-代数可测性          │ 标签必须能从可用信息"推导"出来               │
│ 因果可识别性          │ 不能用未来信息定义当前标签                   │
│ Direct Policy Learning│ 直接优化决策质量，而非状态识别精度           │
│ Fisher可分性          │ 最大化类间差异，最小化类内差异               │
└─────────────────────────────────────────────────────────────────┘
```

---

*报告生成日期: 2025-11-29*
*协作: Claude + Codex*
