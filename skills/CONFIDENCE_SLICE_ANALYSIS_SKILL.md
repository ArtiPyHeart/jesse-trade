# Claude SKILL: 置信度切片分析与过滤器配置

## 任务概述

协助用户分析机器学习模型的置信度切片图表，并根据图表特征配置相应的过滤器（filters），以校准模型的多空交易行为。

## 背景知识

### 核心问题
- 机器学习拟合的是**面板数据**，而量化投资需要考虑**时序性**
- 即便模型拥有较好的拟合效果，在时序上依然存在亏损的可能性

### 解决方案
- 通过置信度切片在测试集上对模型预测概率进行细粒度切分
- 结合实际盈亏制作当前粒度的真实盈亏曲线
- 通过校准后的多个模型投票决定交易行为
  - 所有模型一致预期多头/空头 → 开启相应持仓
  - 模型预测有分歧 → 空仓（利用分歧减少交易次数并降低磨损）

## 工作流程

### 1. 理解用户提供的信息

#### 典型用户请求格式
用户通常会这样提出请求：
> "请帮我完成 temp/c_L3_N1 的置信度切片图片分析"

或
> "请帮我完成 temp/r_L5_N2 的置信度切片图片分析"

#### 模型命名约定（自动解析规则）

从路径 `temp/{MODEL_TYPE}_L{LAG}_N{PRED_NEXT}` 中提取信息：

**命名格式：** `{类型}_L{LAG}_N{PRED_NEXT}`

**参数解析：**
- **第一部分（类型）：**
  - `c` → 分类模型（Classification）
  - `r` → 回归模型（Regression）

- **L{数字}：** log return lag
  - 例如：`L3` → LAG=3, `L5` → LAG=5

- **N{数字}：** 预测未来第N个标签
  - 例如：`N1` → PRED_NEXT=1, `N2` → PRED_NEXT=2

**自动推断默认参数：**

| 模型类型 | LOWER_BOUND | UPPER_BOUND | THRESHOLD | 说明 |
|---------|-------------|-------------|-----------|------|
| 分类 (c) | 0.0 | 1.0 | 0.5 | 输出为概率值 |
| 回归 (r) | -1.0 | 1.0 | 0.0 | 目标永远在[-1,1]，多空分界点为0 |

**解析示例：**
- `temp/c_L3_N1` →
  - MODEL_TYPE = "c"
  - LAG = 3
  - PRED_NEXT = 1
  - LOWER_BOUND = 0.0
  - UPPER_BOUND = 1.0
  - THRESHOLD = 0.5

- `temp/r_L5_N2` →
  - MODEL_TYPE = "r"
  - LAG = 5
  - PRED_NEXT = 2
  - LOWER_BOUND = -1.0
  - UPPER_BOUND = 1.0
  - THRESHOLD = 0.0

#### 工作流程
1. 从用户请求中识别模型路径
2. 解析模型命名，提取参数
3. 根据模型类型自动推断默认参数
4. 读取指定目录下的所有切片图片
5. 开始逐个分析

### 2. 分析置信度切片图表

每张图片包含以下关键信息：
- **切片区间**：`[lower, upper]`，如 [0.84, 0.86]
- **交易方向**：(做多) 或 (做空)
- **样本占比**：该区间样本数占总样本的比例
- **最终收益**：曲线终点的累积盈亏值
- **平均收益**：红色虚线表示的均值
- **曲线形态**：整体走势特征

### 3. 决策准则

根据图表特征，做出以下三种决策之一：

#### 决策A: 不干预（良好区间）

**判断标准：**
- ✅ 曲线总体单调向上
- ✅ 平均收益（红色虚线）> 0
- ✅ 最终收益 > 0

**操作：** 无需添加过滤器，模型在此区间预测良好

**示例描述：** "曲线稳定上升，平均收益为正，模型预测准确，保持原有策略"

#### 决策B: 反向操作（反向区间）

**判断标准：**
- ✅ 曲线总体单调向下
- ✅ 平均收益（红色虚线）< 0
- ✅ 最终收益 < 0

**操作：** 添加反向过滤器
```python
mc.add_reverse_filter(lower_bound, upper_bound)
```

**示例描述：** "曲线持续下降，平均收益为负，模型预测与实际相反，需要添加反向操作过滤器"

#### 决策C: 放弃交易（随机区间）

**判断标准（满足任一即可）：**
- ✅ 样本占比 = 0（无交易数据）
- ✅ 曲线呈S型围绕零轴波动（难以判定方向）
- ✅ 曲线呈半圆形（前半段亏损，后半段盈利，或相反）
- ✅ 平均收益接近0，但波动剧烈

**操作：** 添加空仓过滤器
```python
mc.add_giveup_filter(lower_bound, upper_bound)
```

**示例描述：** "曲线呈S型波动/半圆形走势/无交易数据，模型预测随机性过大，应放弃此区间交易"

### 4. 批量处理流程

当用户提供一个模型的所有切片图片时：

1. **逐个分析**每张图片，记录区间和决策
2. **汇总建议**，生成完整的过滤器配置代码
3. **提供摘要**：
   - 良好区间数量和占比
   - 反向区间数量和占比
   - 放弃区间数量和占比
4. **生成代码**（使用自动解析的参数）：
```python
from strategies.BinanceBtcDeapV1Voting.models.config import LGBMContainer

# 初始化模型容器（参数从路径自动解析）
mc = LGBMContainer(
    model_type="c",  # 从路径解析
    lag=3,           # 从路径解析
    pred_next=1,     # 从路径解析
    threshold=0.5,   # 根据模型类型自动推断
)

print(mc.MODEL_NAME)  # 验证模型名称

# 添加反向操作过滤器
mc.add_reverse_filter(0.02, 0.04)
mc.add_reverse_filter(0.06, 0.08)
# ...

# 添加空仓过滤器
mc.add_giveup_filter(0.48, 0.50)
mc.add_giveup_filter(0.50, 0.52)
# ...

# 保存过滤器配置
mc.save_filters()
```

### 5. 输出格式示例

```markdown
## 置信度切片分析报告

**模型路径：** temp/c_L3_N1

**解析的模型参数：**
- 模型类型：分类模型 (c)
- LAG：3
- PRED_NEXT：1
- THRESHOLD：0.5
- LOWER_BOUND：0.0
- UPPER_BOUND：1.0

### 分析结果摘要
- 总切片数量：50
- 良好区间：32个（64%）
- 反向区间：8个（16%）
- 放弃区间：10个（20%）

### 详细分析

#### 反向区间（需要add_reverse_filter）
1. **[0.02, 0.04]** - 样本占比3.2%
   - 曲线持续下降，最终收益-0.0856，平均收益-0.0421
   - 盈利面积占比仅28%，模型预测与实际相反

2. **[0.06, 0.08]** - 样本占比2.8%
   - ...

#### 放弃区间（需要add_giveup_filter）
1. **[0.48, 0.50]** - 样本占比5.1%
   - 曲线呈S型围绕零轴波动，方向不明确
   - 盈利面积占比49%，接近随机

2. **[0.00, 0.02]** - 样本占比0%
   - 无交易数据

### 配置代码
[生成的Python代码，使用解析的参数]
```

## 注意事项

1. **模型命名解析（关键）：**
   - **必须**从用户提供的路径中自动解析模型参数
   - 格式固定：`temp/{c|r}_L{LAG}_N{PRED_NEXT}`
   - 根据模型类型（c/r）自动推断THRESHOLD、LOWER_BOUND、UPPER_BOUND
   - 在报告开头明确列出解析的参数，让用户验证
   - 如果路径格式不符合约定，向用户确认参数

2. **边界情况处理：**
   - 如果曲线看起来"几乎单调"但有小幅回撤，仍可归为良好/反向区间
   - 如果无法明确判断，倾向于保守，归为放弃区间

3. **样本占比考量：**
   - 样本占比过高（>10%）的区间，需要特别重视其配置

4. **上下文整体性：**
   - 可以建议合并相邻的同类型区间

5. **沟通方式：**
   - 用清晰的术语描述曲线特征
   - 提供决策的明确理由
   - 代码格式规范，易于复制粘贴

## 关键术语

- **模型命名约定**：`{c|r}_L{LAG}_N{PRED_NEXT}` 格式，用于唯一标识一个模型配置
  - c：分类模型，输出0-1概率值，阈值0.5
  - r：回归模型，输出-1到1范围，阈值0
- **置信度切片（Confidence Slice）**：按模型输出概率划分的区间
- **反向操作过滤器（Reverse Filter）**：将做多改为做空，做空改为做多
- **空仓过滤器（Giveup Filter）**：在特定区间不进行交易
- **时序对齐（Temporal Alignment）**：score[i]预测 → close_diff[i+pred_next]
- **LAG**：log return lag，特征工程中使用的滞后期数
- **PRED_NEXT**：预测未来第N个标签，影响时序对齐
