# Claude SKILL: 置信度切片分析与过滤器配置

## 任务概述
分析ML模型的置信度切片图表，根据曲线形态配置过滤器以校准交易行为。通过双重验证机制确保判定准确性。

## 核心逻辑
- 面板数据拟合 + 时序盈亏曲线 → 识别有效/反向/随机区间
- 多模型投票：一致则开仓，分歧则空仓
- **用户必须指定目标策略**（如 `BinanceBtcDeapV1Voting`），未指定则立即停止询问

## 模型命名约定（自动解析）
路径格式：`temp/{类型}_L{LAG}_N{PRED_NEXT}/`

| 模型类型 | LOWER_BOUND | UPPER_BOUND | THRESHOLD |
|---------|-------------|-------------|-----------|
| c (分类) | 0.0 | 1.0 | 0.5 |
| r (回归) | -1.0 | 1.0 | 0.0 |

**示例**：
- `temp/c_L3_N1` → model_type="c", lag=3, pred_next=1, threshold=0.5
- `temp/r_L7_N3` → model_type="r", lag=7, pred_next=3, threshold=0

## 策略验证（强制）
分析前必须验证：
1. 策略目录 `strategies/{STRATEGY_NAME}` 存在
2. 配置文件 `strategies/{STRATEGY_NAME}/models/config.py` 存在
3. `LGBMContainer` 类可从配置文件导入

**任何验证失败立即停止**，不得猜测或创建文件

## 决策准则
**核心原则**：从整体趋势判断，横盘是无害的，反复无常的盈亏切换才是有害的。

每张图片分析后做出以下三种决策之一：

### A. 不干预（good）
**判定条件**（满足以下任一即可）：
1. **整体上升趋势**：最终收益>0 且 平均收益>0，允许以下情况：
   - 中途横盘震荡（只要不大幅亏损并有强烈的趋近零轴的趋势）
   - 小幅回调（幅度不超过累计收益的30%）
   - 阶段性盘整后继续上升
2. **稳定盈利**：曲线长期稳定在盈利区域，总体上符合上升趋势

**关键特征**：
- 起点到终点整体向上
- 大部分时间保持在平均收益线以上
- 没有剧烈的盈利-亏损反复切换

**操作**：无需过滤器

### B. 反向操作（reverse）
**判定条件**（满足以下任一即可）：
1. **整体下降趋势**：最终收益<0 且 平均收益<0，允许以下情况：
   - 中途横盘震荡（只要不大幅盈利并有强烈的趋近零轴的趋势）
   - 短暂反弹后继续下跌
   - 阶段性企稳后继续下降
2. **稳定亏损**：曲线长期稳定在亏损区域，总体上符合下降趋势

**关键特征**：
- 起点到终点整体向下
- 大部分时间保持在平均收益线以下（负值区域）
- 没有剧烈的盈利-亏损反复切换

**操作**：`mc.add_reverse_filter(lower_bound, upper_bound)`

### C. 放弃交易（giveup）
**判定条件**（必须满足以下之一）：
1. **零样本**：样本占比=0，无交易数据
2. **剧烈盈亏切换**：曲线反复穿越零线（或平均收益线），呈现以下模式：
   - **S型波动**：先盈利→亏损→盈利，或 先亏损→盈利→亏损
   - **半圆型波动**：先盈利后亏损，或先亏损后盈利，呈现出半圆形，终点有向零轴回归的趋势
3. **无方向性**：曲线盈利较小或趋近零，整体无明显方向性，曲线来回上下扭动

**关键特征**（giveup的核心标志）：
- **不是横盘**，而是盈利和亏损状态的反复切换
- 曲线在正负区域之间多次大幅穿越
- 收益曲线呈现不可预测的混乱模式

**不应判定为giveup的情况**：
- ❌ 在盈利区长期横盘（应判定为good）
- ❌ 在亏损区长期横盘（应判定为reverse）
- ❌ 有小幅回调但整体向上（应判定为good）
- ❌ 有短暂反弹但整体向下（应判定为reverse）

**操作**：`mc.add_giveup_filter(lower_bound, upper_bound)`

---

**判定优先级**：
1. 先看样本量（=0立即giveup）
2. 再看整体趋势（起点→终点，最终收益±平均收益的符号一致性）
3. 检查曲线是否存在剧烈盈亏反转形态（S型、半圆型）
4. 横盘不影响good/reverse判定，只影响是否需要giveup

**小样本原则**：样本占比<1%时，更应关注整体趋势，忽略局部波动

---

## 工作流程

### 阶段1：准备
1. 提取用户指定的策略名称（未指定则停止）
2. 执行策略验证（失败则停止）
3. 解析模型参数（从路径提取）
4. 扫描目标目录获取所有切片图片（Glob）
5. 检查进度文件：`temp/{模型名称文件夹，如c_L4_N2}/{模型名称}_round1.jsonl`、`_round2.jsonl`、`_final.jsonl`

### 阶段2：双轮并行分析
**第一轮**：
- 图片分组（5-10张/组）
- 启动多个 child agents 并行处理
- 每个 agent 分析曲线特征，做出决策，写入 `_round1.jsonl`
- 验证 JSONL 完整性（行数=图片数，格式正确）

**第二轮**：
- 用相同分组再次启动 child agents **独立分析**
- 写入 `_round2.jsonl`
- 验证 JSONL 完整性

### 阶段3：裁判
1. 对比两轮决策
2. 一致 → 直接写入 `_final.jsonl`
3. 不一致 → 启动裁判 agent：
   - 提供图片、两轮决策和理由
   - 综合判定（形态优先，数值辅助）
   - 无法确定 → 采用 giveup（保守原则）
4. 裁判结果写入 `_final.jsonl`

### 阶段4：生成配置
1. 读取 `_final.jsonl` 分类汇总
2. 生成可执行代码 `apply_filters_{模型名称}.py`：
```python
from strategies.{STRATEGY_NAME}.models.config import LGBMContainer

mc = LGBMContainer(
    model_type="c",  # 从路径解析
    lag=3,
    pred_next=1,
    threshold=0.5,
)

# 从 final.jsonl 自动生成
mc.add_reverse_filter(0.02, 0.04)
mc.add_giveup_filter(0.48, 0.50)
# ...

mc.save_filters()
```
3. 运行代码，保存配置到策略 models 目录
4. 立即删除临时 Python 文件

## JSONL 格式
**round1/round2**：
```jsonl
{"slice": "[0.02, 0.04]", "decision": "reverse", "reason": "曲线持续下降，最终收益-0.0856", "sample_ratio": 0.0148}
```

**final**：
```jsonl
{"slice": "[0.02, 0.04]", "decision": "good", "reason": "裁判判定：综合评估为good", "source": "referee", "sample_ratio": 0.0148}
```

**字段**：slice (区间), decision (good/reverse/giveup), reason (理由), sample_ratio (占比), source (consensus/referee)

## 核心要求
1. **强制验证**：策略目录、config.py、LGBMContainer，失败立即停止
2. **双重验证**：两轮独立分析，不一致由裁判判定
3. **并行处理**：Task tool + child agents（5-10张/组）
4. **完整性检查**：每轮后验证 JSONL（行数、格式），通过后才推进
5. **保守原则**：裁判无法确定或样本=0 → giveup
6. **整体趋势优先**：
   - 看起点到终点的整体方向，而非局部波动
   - 横盘是无害的（在盈利区横盘→good，在亏损区横盘→reverse）
   - 只有反复穿越盈亏分界线的剧烈切换才需要giveup
7. **形态判定标准**：
   - Good/Reverse：允许横盘、允许小幅回调/反弹，只要整体趋势明确
   - Giveup：仅针对盈利-亏损状态反复切换的不稳定曲线
8. **动态代码**：必须使用用户指定的策略名称
