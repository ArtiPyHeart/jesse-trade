# Claude SKILL: 置信度切片分析与过滤器配置

## 任务概述

协助用户分析机器学习模型的置信度切片图表，并根据图表特征配置相应的过滤器（filters），以校准模型的多空交易行为。

## 背景知识

### 核心问题
- 机器学习拟合的是**面板数据**，而量化投资需要考虑**时序性**
- 即便模型拥有较好的拟合效果，在时序上依然存在亏损的可能性

### 解决方案
- 通过置信度切片在测试集上对模型预测概率进行细粒度切分
- 结合实际盈亏制作当前粒度的真实盈亏曲线
- 通过校准后的多个模型投票决定交易行为
  - 所有模型一致预期多头/空头 → 开启相应持仓
  - 模型预测有分歧 → 空仓（利用分歧减少交易次数并降低磨损）

## 工作流程

### 1. 理解用户提供的信息

#### 典型用户请求格式
用户通常会这样提出请求：
> "请帮我完成 temp/c_L3_N1 的置信度切片图片分析"

或
> "@temp/r_L5_N2 请帮我完成置信度切片分析"

#### 模型命名约定（自动解析规则）

从路径 `temp/{MODEL_TYPE}_L{LAG}_N{PRED_NEXT}` 中提取信息：

**命名格式：** `{类型}_L{LAG}_N{PRED_NEXT}`

**参数解析：**
- **第一部分（类型）：**
  - `c` → 分类模型（Classification）
  - `r` → 回归模型（Regression）

- **L{数字}：** log return lag
  - 例如：`L3` → LAG=3, `L5` → LAG=5

- **N{数字}：** 预测未来第N个标签
  - 例如：`N1` → PRED_NEXT=1, `N2` → PRED_NEXT=2

**自动推断默认参数：**

| 模型类型 | LOWER_BOUND | UPPER_BOUND | THRESHOLD | 说明 |
|---------|-------------|-------------|-----------|------|
| 分类 (c) | 0.0 | 1.0 | 0.5 | 输出为概率值 |
| 回归 (r) | -1.0 | 1.0 | 0.0 | 目标永远在[-1,1]，多空分界点为0 |

**解析示例：**
- `temp/c_L3_N1` →
  - MODEL_TYPE = "c"
  - LAG = 3
  - PRED_NEXT = 1
  - LOWER_BOUND = 0.0
  - UPPER_BOUND = 1.0
  - THRESHOLD = 0.5

- `temp/r_L5_N2` →
  - MODEL_TYPE = "r"
  - LAG = 5
  - PRED_NEXT = 2
  - LOWER_BOUND = -1.0
  - UPPER_BOUND = 1.0
  - THRESHOLD = 0.0

#### 工作流程
1. 从用户请求中识别模型路径
2. 解析模型命名，提取参数
3. 根据模型类型自动推断默认参数
4. 读取指定目录下的所有切片图片
5. 开始逐个分析

### 2. 分析置信度切片图表

每张图片包含以下关键信息：
- **切片区间**：`[lower, upper]`，如 [0.84, 0.86]
- **交易方向**：(做多) 或 (做空)
- **样本占比**：该区间样本数占总样本的比例
- **最终收益**：曲线终点的累积盈亏值
- **平均收益**：红色虚线表示的均值
- **曲线形态**：整体走势特征

### 3. 决策准则

根据图表特征，做出以下三种决策之一：

#### 决策A: 不干预（良好区间）

**判断标准：**
- ✅ 曲线总体单调向上
- ✅ 平均收益（红色虚线）> 0
- ✅ 最终收益 > 0

**操作：** 无需添加过滤器，模型在此区间预测良好

**示例描述：** "曲线稳定上升，平均收益为正，模型预测准确，保持原有策略"

#### 决策B: 反向操作（反向区间）

**判断标准：**
- ✅ 曲线总体单调向下
- ✅ 平均收益（红色虚线）< 0
- ✅ 最终收益 < 0

**操作：** 添加反向过滤器
```python
mc.add_reverse_filter(lower_bound, upper_bound)
```

**示例描述：** "曲线持续下降，平均收益为负，模型预测与实际相反，需要添加反向操作过滤器"

#### 决策C: 放弃交易（随机区间）

**判断标准（满足任一即可）：**
- ✅ 样本占比 = 0（无交易数据）
- ✅ 曲线呈S型围绕零轴波动（难以判定方向）
- ✅ 曲线呈半圆形（前半段亏损，后半段盈利，或相反）
- ✅ 平均收益接近0，但波动剧烈

**操作：** 添加空仓过滤器
```python
mc.add_giveup_filter(lower_bound, upper_bound)
```

**示例描述：** "曲线呈S型波动/半圆形走势/无交易数据，模型预测随机性过大，应放弃此区间交易"

### 4. 批量处理流程（双重验证机制）

#### 核心策略：双重分析 + 裁判机制

由于 child agent 对图表走势的判断存在随机性，**必须采用双重验证机制**以确保判定准确性。

**核心原则：**
- 对所有切片图片进行**两轮完整的独立分析**
- 两次结论一致 → 直接采纳
- 两次结论不一致 → 启动裁判 agent 综合判定
- 裁判无法确定 → 保守策略，采用 giveup

---

**完整工作流程：**

#### **阶段1：准备与检查**
1. 解析模型参数（从路径提取，如 `temp/c_L3_N1`）
2. 扫描目标目录，获取所有切片图片列表（使用 Glob 工具）
3. 检查进度文件是否存在：
   - `temp/{模型名称}_round1.jsonl` (第一轮分析)
   - `temp/{模型名称}_round2.jsonl` (第二轮分析)
   - `temp/{模型名称}_final.jsonl` (最终结果)
4. 如果用户要求"重新分析"：
   - 删除所有临时文件
   - 重新开始双重分析

#### **阶段2A：第一轮并行分析**
1. 将所有图片分组（建议每组5-10张）
2. 使用 Task tool 启动多个 child agent 并行处理
3. 每个 child agent：
   - 读取图片
   - 分析曲线特征（最终收益、平均收益、盈利面占比、曲线形态）
   - 做出决策（good/reverse/giveup）
   - 将结果追加到 `temp/{模型名称}_round1.jsonl`
4. 等待所有 child agent 完成

#### **阶段2B：第二轮并行分析**
1. 使用**相同的图片分组**再次启动 child agent
2. 每个 child agent **独立分析**（不参考第一轮结果）
3. 将结果追加到 `temp/{模型名称}_round2.jsonl`
4. 等待所有 child agent 完成

#### **阶段3：一致性检查与裁判**
1. 读取两轮分析结果
2. 逐个切片对比两轮决策：

   **情况A：两轮结论一致**
   - 示例：round1=good, round2=good
   - 操作：直接采纳，写入 `temp/{模型名称}_final.jsonl`

   **情况B：两轮结论不一致**
   - 示例：round1=good, round2=giveup
   - 操作：启动裁判 agent 进行综合判定

3. 对所有不一致的切片，启动裁判 child agent：
   - 提供该切片的图片路径
   - 提供两轮分析的决策和理由
   - 要求裁判 agent：
     - 重新读取图片
     - 对比两轮理由的合理性
     - 综合考量数据指标（最终收益、平均收益、盈利面占比）
     - 给出最终判定（good/reverse/giveup）
     - 如果无法确定倾向性 → 采用 **giveup**（保守原则）

4. 将裁判结果写入 `temp/{模型名称}_final.jsonl`

#### **阶段4：汇总与生成**
1. 读取 `temp/{模型名称}_final.jsonl`
2. 按决策类型分类汇总：
   - 良好区间（good）
   - 反向区间（reverse）
   - 放弃区间（giveup）
3. 统计一致性指标：
   - 两轮一致的切片数量
   - 需要裁判的切片数量
   - 裁判采用giveup的数量（说明信号不明确）
4. 生成详细分析报告
5. 在项目根目录生成可执行的配置代码并运行代码保存filter结果
6. 保存filter结果后立即删除配置filter的.py代码

#### 临时文件管理

除非需要重新分析或用户要求清理，否则保留所有临时文件供后续审查。

**文件命名规则：**
- `temp/{模型名称}_round1.jsonl` - 第一轮分析结果
- `temp/{模型名称}_round2.jsonl` - 第二轮分析结果
- `temp/{模型名称}_conflicts.jsonl` - 不一致的切片列表（供裁判使用）
- `temp/{模型名称}_final.jsonl` - 最终采纳的结果

**示例：**
- `temp/c_L3_N1_round1.jsonl`
- `temp/c_L3_N1_round2.jsonl`
- `temp/c_L3_N1_conflicts.jsonl`
- `temp/c_L3_N1_final.jsonl`

---

**第一轮/第二轮分析文件格式（JSONL）：**
```jsonl
{"slice": "[0.02, 0.04]", "decision": "reverse", "reason": "曲线持续下降，最终收益-0.0856，平均收益-0.0421，盈利面38%", "sample_ratio": 0.0148}
{"slice": "[0.04, 0.06]", "decision": "good", "reason": "曲线整体上升，最终收益0.9904，平均收益1.3296，盈利面56.67%", "sample_ratio": 0.0257}
```

**不一致列表文件格式（conflicts.jsonl）：**
```jsonl
{"slice": "[0.02, 0.04]", "round1": {"decision": "giveup", "reason": "曲线剧烈波动"}, "round2": {"decision": "good", "reason": "最终收益0.4181为正"}, "sample_ratio": 0.0148}
```

**最终结果文件格式（final.jsonl）：**
```jsonl
{"slice": "[0.02, 0.04]", "decision": "good", "reason": "裁判判定：最终收益0.4181，平均收益0.3049，盈利面55.60%，综合评估为good区间", "source": "referee", "sample_ratio": 0.0148}
{"slice": "[0.04, 0.06]", "decision": "good", "reason": "两轮一致：曲线整体上升", "source": "consensus", "sample_ratio": 0.0257}
```

**JSON字段说明：**
- `slice` (string): 切片区间，如 "[0.02, 0.04]"
- `decision` (string): 决策类型，"good" / "reverse" / "giveup"
- `reason` (string): 决策理由简述（包含关键指标）
- `sample_ratio` (float): 样本占比（0-1之间）
- `source` (string): 决策来源，"consensus"（两轮一致）/ "referee"（裁判判定）
- `round1/round2` (object): 各轮的决策和理由（仅在conflicts.jsonl中）

#### 配置代码生成示例

```python
from strategies.BinanceBtcDeapV1Voting.models.config import LGBMContainer

# 初始化模型容器（参数从路径自动解析）
mc = LGBMContainer(
    model_type="c",  # 从 temp/c_L3_N1 解析
    lag=3,           # 从路径解析
    pred_next=1,     # 从路径解析
    threshold=0.5,   # 根据模型类型自动推断
)

print(mc.MODEL_NAME)  # 验证: model_c_L3_N1

# 添加反向操作过滤器（从临时文件汇总）
mc.add_reverse_filter(0.02, 0.04)
mc.add_reverse_filter(0.06, 0.08)
# ...

# 添加空仓过滤器（从临时文件汇总）
mc.add_giveup_filter(0.48, 0.50)
mc.add_giveup_filter(0.50, 0.52)
# ...

# 保存过滤器配置
mc.save_filters()
print(f"过滤器配置已保存至: {mc.filter_file_path}")
```

### 5. 输出格式示例

#### 分析开始阶段

## 置信度切片分析 - 开始（双重验证模式）

**模型路径：** temp/c_L3_N1

**解析的模型参数：**
- 模型类型：分类模型 (c)
- LAG：3
- PRED_NEXT：1
- THRESHOLD：0.5
- LOWER_BOUND：0.0
- UPPER_BOUND：1.0

**扫描结果：**
- 发现 50 张切片图片
- 临时文件状态：未开始（将创建 round1/round2/conflicts/final 文件）

**执行计划：**
- **阶段2A：** 第一轮并行分析（启动10个child agent，每组5张）
- **阶段2B：** 第二轮并行分析（独立重新分析）
- **阶段3：** 一致性检查与裁判机制
- **阶段4：** 汇总生成配置代码

#### 进度更新示例

**[第一轮分析] 进度更新：**
- 已完成 50/50 张图片分析（100%）
- 结果已保存至：temp/c_L3_N1_round1.jsonl

**[第二轮分析] 进度更新：**
- 已完成 50/50 张图片分析（100%）
- 结果已保存至：temp/c_L3_N1_round2.jsonl

**[一致性检查] 统计结果：**
- 两轮一致的切片：38个（76%）
- 需要裁判的切片：12个（24%）
- 正在启动裁判 agent 处理不一致情况...

**[裁判判定] 完成：**
- 裁判已完成 12 个切片的综合判定
- 最终结果已保存至：temp/c_L3_N1_final.jsonl

#### 最终分析报告

## 置信度切片分析报告（双重验证）

**模型路径：** temp/c_L3_N1

**解析的模型参数：**
- 模型类型：分类模型 (c)
- LAG：3
- PRED_NEXT：1
- THRESHOLD：0.5
- LOWER_BOUND：0.0
- UPPER_BOUND：1.0

---

### 双重验证统计

- **总切片数量：** 50
- **两轮一致：** 38个（76%）- 高可信度
- **需要裁判：** 12个（24%）- 存在分歧
- **裁判采用giveup：** 3个（6%）- 信号不明确

### 最终决策分布

- **良好区间：** 15个（30%）- 无需配置
- **反向区间：** 9个（18%）- 需要 add_reverse_filter
- **放弃区间：** 26个（52%）- 需要 add_giveup_filter

### 关键发现

1. **一致性良好：** 76%的切片两轮判定一致，说明判定标准相对明确
2. **需要裁判的切片：** 主要集中在边界区域（如盈利面接近50%的切片）
3. **保守策略生效：** 裁判无法确定的3个切片已采用giveup，避免误判风险

### 配置代码

```python
from strategies.BinanceBtcDeapV1Voting.models.config import LGBMContainer

# 初始化模型容器
mc = LGBMContainer(
    model_type="c",
    lag=3,
    pred_next=1,
    threshold=0.5,
)

print(mc.MODEL_NAME)  # 验证: model_c_L3_N1

# 添加反向操作过滤器（8个区间）
mc.add_reverse_filter(0.02, 0.04)
mc.add_reverse_filter(0.06, 0.08)
# ... 共8个

# 添加空仓过滤器（10个区间）
mc.add_giveup_filter(0.00, 0.02)
mc.add_giveup_filter(0.48, 0.50)
# ... 共10个

# 保存过滤器配置
mc.save_filters()
print(f"过滤器配置已保存至: {mc.filter_file_path}")
```

## 注意事项

1. **模型命名解析（关键）：**
   - **必须**从用户提供的路径中自动解析模型参数
   - 格式固定：`temp/{c|r}_L{LAG}_N{PRED_NEXT}`
   - 根据模型类型（c/r）自动推断THRESHOLD、LOWER_BOUND、UPPER_BOUND
   - 在报告开头明确列出解析的参数，让用户验证
   - 如果路径格式不符合约定，向用户确认参数

2. **双重验证机制（核心要求）：**
   - **必须**执行两轮完整的独立分析，不可省略
   - 两轮分析使用相同的图片分组，但完全独立进行
   - 第二轮分析时，child agent **不得**查看第一轮结果
   - 所有不一致的切片**必须**通过裁判 agent 判定
   - 裁判 agent 需要明确说明判定理由，包含具体数值

3. **并行分析策略（重要）：**
   - **优先使用 Task tool 启动 child agent 进行并行分析**
   - 每张图片独立分析，互不依赖，天然适合并行
   - 建议每组5-10张图片，避免启动过多 agent
   - 第一轮和第二轮分别并行，但两轮之间必须串行（等第一轮全部完成）

4. **临时文件管理（必需）：**
   - **必须**创建4个临时文件：round1.jsonl、round2.jsonl、conflicts.jsonl、final.jsonl
   - 除非用户要求重新分析，否则保留所有临时文件供审查
   - 使用 JSONL 格式（每行一个独立的 JSON 对象），便于追加和解析
   - final.jsonl 必须标注每个决策的来源（consensus或referee）

5. **裁判 Agent 指导原则：**
   - 裁判必须重新读取图片，而非仅凭两轮理由判断
   - 裁判需要明确提取图表中的**数值指标**（最终收益、平均收益、盈利面占比）
   - 对比两轮理由的合理性，找出分歧点
   - 优先采用数值指标进行判定，曲线形态作为辅助
   - 如果数值指标矛盾或都接近边界值 → 采用 **giveup**（保守原则）
   - 裁判的reason字段必须说明：采用哪个判定，为什么，关键数值是什么

6. **边界情况处理：**
   - 如果曲线看起来"几乎单调"但有小幅回撤，仍可归为良好/反向区间
   - 如果无法明确判断，倾向于保守，归为放弃区间

7. **样本占比考量：**
   - 样本占比较高（>5%）的区间，需要特别重视其配置
   - 样本占比为0的区间，自动归为放弃区间（两轮一致，无需裁判）

8. **上下文整体性：**
   - 可以建议合并相邻的同类型区间
   - 在最终报告中按区间顺序排列，便于查看连续性

9. **沟通方式：**
   - 用清晰的术语描述曲线特征
   - 提供决策的明确理由
   - 代码格式规范，易于复制粘贴
   - 在各阶段明确告知用户进度：
     - "正在进行第一轮分析..."
     - "第一轮完成，开始第二轮分析..."
     - "检测到12个不一致切片，启动裁判机制..."
     - "裁判完成，生成最终配置..."

## 关键术语

### 模型相关
- **模型命名约定**：`{c|r}_L{LAG}_N{PRED_NEXT}` 格式，用于唯一标识一个模型配置
  - c：分类模型，输出0-1概率值，阈值0.5
  - r：回归模型，输出-1到1范围，阈值0
- **置信度切片（Confidence Slice）**：按模型输出概率划分的区间
- **LAG**：log return lag，特征工程中使用的滞后期数
- **PRED_NEXT**：预测未来第N个标签，影响时序对齐
- **时序对齐（Temporal Alignment）**：score[i]预测 → close_diff[i+pred_next]

### 过滤器相关
- **反向操作过滤器（Reverse Filter）**：将做多改为做空，做空改为做多
- **空仓过滤器（Giveup Filter）**：在特定区间不进行交易
- **良好区间（Good）**：模型预测准确，保持原有策略
- **反向区间（Reverse）**：模型预测相反，需要反向操作
- **放弃区间（Giveup）**：模型预测随机性过大，应放弃交易

### 双重验证机制相关
- **双重验证（Double Verification）**：对所有切片进行两轮独立分析，提高判定可靠性
- **第一轮分析（Round 1）**：初次并行分析所有切片，结果保存至 round1.jsonl
- **第二轮分析（Round 2）**：独立重新分析所有切片，不参考第一轮结果，保存至 round2.jsonl
- **一致性检查（Consistency Check）**：对比两轮分析结果，识别不一致的切片
- **裁判机制（Referee Mechanism）**：对两轮判定不一致的切片，启动裁判 agent 综合判定
- **裁判 Agent（Referee Agent）**：专门处理分歧切片的 child agent，需重新读取图片并综合两轮理由
- **保守原则（Conservative Principle）**：裁判无法确定时，采用 giveup 过滤器，避免误判
- **决策来源（Source）**：
  - consensus：两轮一致，直接采纳
  - referee：两轮不一致，由裁判判定

### 技术实现相关
- **Child Agent 并行分析**：使用 Task tool 启动多个独立的分析代理，并行处理不同的图片组
- **临时文件（Temporary Files）**：JSONL格式文件，记录分析过程和结果
  - round1.jsonl：第一轮分析结果
  - round2.jsonl：第二轮分析结果
  - conflicts.jsonl：两轮不一致的切片列表
  - final.jsonl：最终采纳的决策结果
- **JSONL 格式**：每行一个独立的JSON对象，便于追加写入和逐行解析
