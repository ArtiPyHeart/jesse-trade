# Claude SKILL: 模型快速筛选与质量评估

## 任务概述
在进行完整的置信度切片分析之前，通过抽样检查每个模型的关键切片图片，快速评估模型质量和稳定性，生成优先级排序报告，帮助交易员确定分析顺序。

## 核心逻辑
- temp/ 目录下通常存在 10-50 个模型，逐一完整分析耗时巨大
- 通过抽样关键切片（边界值 + 高样本量）可快速判断模型的预测能力
- **边界值切片**反映模型在高置信度时的表现（应最稳定）
- **高样本量切片**反映模型主要预测区间的可靠性

## 关键简化：统一判断标准

**所有置信度切片图片在绘图时已做反转处理**，因此：
- **曲线单调向上 = 盈利**
- **曲线单调向下 = 亏损**
- **无需考虑做多/做空的方向反转**，直接判断曲线走势即可

## 模型目录结构
```
temp/
├── c_L4_N1/          # 分类模型 [0, 1]
├── c_L4_N2/
├── ...
├── r_L4_N1/          # 回归模型 [-1, 1]
├── r_L4_N2/
└── ...
```

**文件命名规范**：`slice_{lower}_{upper}_ratio_{sample_ratio}.jpg`
- 示例：`slice_0.9400_0.9600_ratio_0.0243.jpg`（粒度0.02）
- lower/upper：切片区间边界
- ratio：该切片样本占总样本的比例

**注意**：切片粒度不固定，可能是 0.01 或 0.02，需从文件名动态解析。

## 抽样策略

### 分类模型 (threshold=0.5)
| 区域 | 切片范围 | 抽样数量 | 意义 |
|------|---------|---------|------|
| 多头边界 | 接近 1.0 的 3-4 张 | 3-4 | 模型最确信做多时的表现 |
| 空头边界 | 接近 0.0 的 3-4 张 | 3-4 | 模型最确信做空时的表现 |
| 高样本量 | ratio 最大的切片 | 2-3 | 模型主要预测区间 |

### 回归模型 (threshold=0)
| 区域 | 切片范围 | 抽样数量 | 意义 |
|------|---------|---------|------|
| 多头边界 | 接近 1.0 的 3-4 张 | 3-4 | 模型最确信做多时的表现 |
| 空头边界 | 接近 -1.0 的 3-4 张 | 3-4 | 模型最确信做空时的表现 |
| 高样本量 | ratio 最大的切片 | 2-3 | 模型主要预测区间 |

**每个模型抽样 8-11 张图片**（边界各 3-4 张 + 高样本量 2-3 张）

### 边界切片选取方法
1. 列出所有切片文件，按 lower 值排序
2. 多头边界：取 lower 值最大的 3-4 张（最接近上界）
3. 空头边界：取 lower 值最小的 3-4 张（最接近下界）
4. 高样本量：按 ratio 降序排列，取前 2-3 张

### 重复切片处理（重要）
若某切片同时属于边界和高样本量：
- **图片只看一次**：无需重复分析同一张图片
- **得分双重计入**：该切片的得分同时计入边界平均分和高样本量平均分
- **标记重复**：在报告中标注 `[边界+高样本]`

**示例**：
- `[0.00, 0.02]` 既是空头边界，又是 ratio=41.7% 的高样本量切片
- 分析一次，得分 4 分
- 边界得分计算时包含此 4 分
- 高样本量得分计算时也包含此 4 分

## 评估标准

### 核心原则：基于曲线形态判断

**关键理解**：我们关注的是**曲线整体形态**，而不是相对于零轴的波动。

**辅助判断方法**（与 CONFIDENCE_SLICE_ANALYSIS_SKILL 对齐）：
> 想象用一条线性回归直线拟合曲线，通过斜率辅助判断：
> - 斜率大幅 > 0 → 整体上升趋势（good）
> - 斜率大幅 < 0 → 整体下降趋势（reverse）
> - 斜率 ≈ 0 或曲线有明显反转形态 → 无方向性（giveup）

### 曲线形态分类

**A. 整体趋势型（可用）**

| 形态 | 特征 | 分数 | 决策 |
|------|------|------|------|
| 整体上升 | 起点→终点整体向上，允许小幅回调（<30%）和横盘 | 5 | good |
| 整体下降 | 起点→终点整体向下，允许小幅反弹（<30%）和横盘 | 4 | reverse |

**B. 反转形态型（必须放弃）**

| 形态 | 特征 | 分数 | 决策 |
|------|------|------|------|
| U型/V型 | 先下降后上升，终点回归起点附近 | 1 | giveup |
| 倒U型/∩型 | 先上升后下降，终点回归起点附近 | 1 | giveup |
| S型/W型/M型 | 多次趋势反转，盈亏状态切换2次以上 | 1 | giveup |
| 无方向 | 曲线来回扭动，无明确趋势 | 1 | giveup |

**C. 弱趋势型（需关注）**

| 形态 | 特征 | 分数 | 决策 |
|------|------|------|------|
| 弱上升 | 有明显波动但整体向上，回调幅度30-50% | 3 | good（需关注） |
| 弱下降 | 有明显波动但整体向下，反弹幅度30-50% | 3 | reverse（需关注） |

### 关键判断要点

1. **横盘 ≠ 波动**
   - 在盈利区长期横盘 → good（5分）
   - 在亏损区长期横盘 → reverse（4分）
   - 横盘不影响趋势判定

2. **反转形态是核心问题**
   - 即使最终收益为正，如果曲线呈 U型/倒U型/S型 → giveup
   - 因为这种形态说明模型预测在时序上不稳定

3. **小样本区间特殊处理**
   - 样本=0 → 直接 giveup（1分）
   - 样本极少但曲线呈单调趋势 → 按趋势评分（可能捕捉到暴涨暴跌）

### 评估结果分类

| 类别 | 形态 | 分数 | 可用性 |
|------|------|------|--------|
| A | 整体上升 | 5 | 直接使用 |
| B | 整体下降 | 4 | 可通过 reverse filter 反转使用 |
| C | 弱上升/弱下降 | 3 | 基本可用，需关注 |
| D | 反转形态（U/倒U/S/W/M型） | 1 | 只能放弃（giveup） |
| E | 无样本 | 1 | 只能放弃（giveup） |

**核心原则**：
- 整体上升（5分）：最佳，直接使用
- 整体下降（4分）：次佳，可反转后使用
- **反转形态（1分）**：最差，无论最终盈亏都无法使用，只能放弃

### 模型综合评分
```
模型得分 = (边界切片平均分 × 0.5) + (高样本量切片平均分 × 0.5)
```
- 边界切片权重更高：反映模型核心预测能力
- 高样本量权重次之：反映模型日常稳定性

### 质量等级划分
| 等级 | 分数范围 | 建议 |
|------|---------|------|
| A | 4.0-5.0 | 优先分析，潜力模型 |
| B | 3.0-3.9 | 次优先分析 |
| C | 2.0-2.9 | 低优先级，可选分析 |
| D | 1.0-1.9 | 建议跳过或重新训练 |

## 工作流程

### 阶段1：目录扫描
1. 扫描 `temp/` 目录，获取所有模型文件夹列表
2. 按模型类型和参数分组（c/r, LAG, PRED_NEXT）
3. 统计每个模型的切片数量
4. 检测切片粒度（从文件名解析 upper - lower）

### 阶段2：并行抽样分析
1. 为每个模型确定抽样图片：
   - 按 lower 值排序，选取边界切片
   - 解析文件名提取 ratio，排序找出高样本量切片
2. 启动多个 child agents 并行处理（每个 agent 处理 2-3 个模型）
3. 每个 agent：
   - 读取抽样图片
   - 按评估标准打分（曲线向上=盈利=好）
   - 记录关键观察

### 阶段3：汇总与排序
1. 收集所有 agent 的评估结果
2. 计算每个模型的综合得分
3. 按得分降序排列
4. 划分质量等级

### 阶段4：生成报告
在项目根目录生成 `MODEL_SCREENING_REPORT.md`

## 报告格式

```markdown
# 模型快速筛选报告

生成时间：{timestamp}
扫描目录：temp/
模型总数：{count}
切片粒度：{granularity}

## 综合排名

| 排名 | 模型 | 综合得分 | 等级 | 边界得分 | 样本得分 | 建议 |
|------|------|---------|------|---------|---------|------|
| 1 | c_L5_N2 | 4.3 | A | 4.5 | 4.0 | 优先分析 |
| 2 | r_L4_N1 | 4.1 | A | 4.2 | 3.9 | 优先分析 |
| ... | ... | ... | ... | ... | ... | ... |

## 分类模型详情

### c_L4_N1 (得分: 3.8, 等级: B)

**边界切片分析**：
| 切片 | 区域 | 样本占比 | 得分 | 观察 |
|------|-----|---------|------|------|
| [0.94, 0.96] | 多头 | 2.4% | 4 | 整体上升，末端小幅回调 |
| [0.96, 0.98] | 多头 | 1.6% | 4 | 稳定上升 |
| [0.98, 1.00] | 多头 | 23.9% | 5 | 强单调上升 `[+高样本]` |
| [0.00, 0.02] | 空头 | 41.7% | 4 | 稳定上升 `[+高样本]` |
| [0.02, 0.04] | 空头 | 2.3% | 4 | 稳定上升 |
| [0.04, 0.06] | 空头 | 1.6% | 3 | 有横盘 |

**高样本量切片分析**：
| 切片 | 样本占比 | 得分 | 备注 |
|------|---------|------|------|
| [0.00, 0.02] | 41.7% | 4 | 已计入边界（空头） |
| [0.98, 1.00] | 23.9% | 5 | 已计入边界（多头） |
| [0.48, 0.50] | 15.2% | 2 | 接近阈值，方向模糊 |

**综合评价**：边界表现良好，但高样本区（阈值附近）表现一般，建议完整分析时重点校准阈值区域。

---

## 回归模型详情
...

## 建议分析顺序

### 优先分析（A级）
1. c_L5_N2 - 边界表现最佳
2. r_L4_N1 - 多空边界均稳定

### 次优先（B级）
3. c_L4_N1
4. ...

### 低优先级（C级）
...

### 建议跳过（D级）
...
```

## Child Agent Prompt 模板

```
你是模型质量评估专家。请分析以下模型的抽样切片图片。

模型信息：
- 名称：{model_name}
- 类型：{model_type} (c=分类, r=回归)
- LAG：{lag}
- PRED_NEXT：{pred_next}

**重要**：所有图片已做反转处理
- 曲线向上 = 盈利
- 曲线向下 = 亏损
- 无需考虑做多/做空方向

**核心原则：基于曲线形态判断**

我们关注的是**曲线整体形态**，而不是相对于零轴的波动。

**辅助判断方法**：想象用一条线性回归直线拟合曲线：
- 斜率大幅 > 0 → 整体上升趋势
- 斜率大幅 < 0 → 整体下降趋势
- 斜率 ≈ 0 或曲线有明显反转形态 → 无方向性

**曲线形态分类与评分**：

A. 整体趋势型（可用）：
- 5分：整体上升 - 起点→终点向上，允许小幅回调（<30%）和横盘
- 4分：整体下降 - 起点→终点向下，允许小幅反弹（<30%）和横盘

B. 反转形态型（必须放弃）：
- 1分：U型/V型 - 先下降后上升，终点回归起点附近
- 1分：倒U型/∩型 - 先上升后下降，终点回归起点附近
- 1分：S型/W型/M型 - 多次趋势反转
- 1分：无方向 - 曲线来回扭动，无明确趋势
- 1分：无样本 - 样本占比=0

C. 弱趋势型（需关注）：
- 3分：弱上升/弱下降 - 有明显波动但整体方向明确，回调幅度30-50%

**关键判断要点**：
1. 横盘 ≠ 反转形态（横盘在盈利区=5分，在亏损区=4分）
2. 反转形态是核心问题，即使最终收益为正，U型/倒U型/S型 = 1分
3. 曲线形态比最终盈亏更重要！

请以JSON格式返回结果：
{
  "model": "{model_name}",
  "slices": [
    {
      "slice": "[0.00, 0.02]",
      "ratio": 0.417,
      "is_boundary": true,
      "boundary_region": "short",
      "is_high_sample": true,
      "shape": "uptrend",
      "score": 5,
      "observation": "整体上升趋势，边界与高样本重叠"
    },
    {
      "slice": "[0.03, 0.04]",
      "ratio": 0.026,
      "is_boundary": true,
      "boundary_region": "short",
      "is_high_sample": false,
      "shape": "inverted_u",
      "score": 1,
      "observation": "倒U型形态，先下降后回升但终点仍亏损"
    },
    ...
  ],
  "boundary_avg": 4.5,
  "high_sample_avg": 3.0,
  "overall_score": 3.9,
  "reversal_count": 1,
  "summary": "边界切片表现良好，但[0.03,0.04]呈倒U型需放弃..."
}

**shape 字段取值**：
- uptrend: 整体上升（5分）
- downtrend: 整体下降（4分）
- weak_uptrend: 弱上升（3分）
- weak_downtrend: 弱下降（3分）
- u_shape: U型/V型反转（1分）
- inverted_u: 倒U型/∩型反转（1分）
- s_shape: S型/W型/M型多次反转（1分）
- no_direction: 无方向（1分）
- no_sample: 无样本（1分）

**计算说明**：
- boundary_avg：所有 is_boundary=true 切片的平均分
- high_sample_avg：所有 is_high_sample=true 切片的平均分
- 重复切片同时计入两个平均分
- overall_score = boundary_avg × 0.6 + high_sample_avg × 0.4
- reversal_count：反转形态切片数量（u_shape/inverted_u/s_shape）
```

## 核心要求

1. **快速筛选**：每个模型仅查看 8-11 张关键图片，不做完整分析
2. **形态优先**：基于曲线整体形态判断，而非零轴波动
3. **反转形态识别**：U型/倒U型/S型等反转形态必须判定为 giveup（1分）
4. **动态适配**：自动检测切片粒度（0.01/0.02），适配边界选取
5. **并行处理**：使用 Task tool + child agents 并行评估多个模型
6. **客观评分**：严格按照评分标准，不因模型数量多而放宽标准
7. **报告实用**：生成的报告应直接指导分析优先级决策
8. **标记反转切片**：记录 reversal_count，反转形态切片多的模型需谨慎
9. **完整覆盖**：确保所有 temp/ 下的模型都被评估

## 与置信度切片分析的关系

```
模型快速筛选（本SKILL）
        ↓
   生成优先级报告
        ↓
   用户决定分析顺序
        ↓
置信度切片分析（CONFIDENCE_SLICE_ANALYSIS_SKILL）
        ↓
   配置过滤器
```

本SKILL是置信度切片分析的**前置步骤**，帮助用户在大量模型中快速识别高潜力目标。
