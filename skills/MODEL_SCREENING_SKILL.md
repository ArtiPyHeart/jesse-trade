# Claude SKILL: 模型快速筛选与质量评估

## 任务概述
在进行完整的置信度切片分析之前，通过抽样检查每个模型的关键切片图片，快速评估模型质量和稳定性，生成优先级排序报告，帮助交易员确定分析顺序。

## 核心逻辑
- temp/ 目录下通常存在 10-50 个模型，逐一完整分析耗时巨大
- 通过抽样关键切片（边界值 + 高样本量）可快速判断模型的预测能力
- **边界值切片**反映模型在高置信度时的表现（应最稳定）
- **高样本量切片**反映模型主要预测区间的可靠性

## 关键简化：统一判断标准

**所有置信度切片图片在绘图时已做反转处理**，因此：
- **曲线单调向上 = 盈利**
- **曲线单调向下 = 亏损**
- **无需考虑做多/做空的方向反转**，直接判断曲线走势即可

## 模型目录结构
```
temp/
├── c_L4_N1/          # 分类模型 [0, 1]
├── c_L4_N2/
├── ...
├── r_L4_N1/          # 回归模型 [-1, 1]
├── r_L4_N2/
└── ...
```

**文件命名规范**：`slice_{lower}_{upper}_ratio_{sample_ratio}.jpg`
- 示例：`slice_0.9400_0.9600_ratio_0.0243.jpg`（粒度0.02）
- lower/upper：切片区间边界
- ratio：该切片样本占总样本的比例

**注意**：切片粒度不固定，可能是 0.01 或 0.02，需从文件名动态解析。

## 抽样策略

### 分类模型 (threshold=0.5)
| 区域 | 切片范围 | 抽样数量 | 意义 |
|------|---------|---------|------|
| 多头边界 | 接近 1.0 的 3-4 张 | 3-4 | 模型最确信做多时的表现 |
| 空头边界 | 接近 0.0 的 3-4 张 | 3-4 | 模型最确信做空时的表现 |
| 高样本量 | ratio 最大的切片 | 2-3 | 模型主要预测区间 |

### 回归模型 (threshold=0)
| 区域 | 切片范围 | 抽样数量 | 意义 |
|------|---------|---------|------|
| 多头边界 | 接近 1.0 的 3-4 张 | 3-4 | 模型最确信做多时的表现 |
| 空头边界 | 接近 -1.0 的 3-4 张 | 3-4 | 模型最确信做空时的表现 |
| 高样本量 | ratio 最大的切片 | 2-3 | 模型主要预测区间 |

**每个模型抽样 8-11 张图片**（边界各 3-4 张 + 高样本量 2-3 张）

### 边界切片选取方法
1. 列出所有切片文件，按 lower 值排序
2. 多头边界：取 lower 值最大的 3-4 张（最接近上界）
3. 空头边界：取 lower 值最小的 3-4 张（最接近下界）
4. 高样本量：按 ratio 降序排列，取前 2-3 张

### 重复切片处理（重要）
若某切片同时属于边界和高样本量：
- **图片只看一次**：无需重复分析同一张图片
- **得分双重计入**：该切片的得分同时计入边界平均分和高样本量平均分
- **标记重复**：在报告中标注 `[边界+高样本]`

**示例**：
- `[0.00, 0.02]` 既是空头边界，又是 ratio=41.7% 的高样本量切片
- 分析一次，得分 4 分
- 边界得分计算时包含此 4 分
- 高样本量得分计算时也包含此 4 分

## 评估标准

### 双维度评估框架

评估每张切片图片需考虑**两个独立维度**：

**维度1：单调性**（最重要）
- 单调：曲线整体朝一个方向移动，允许小幅回调/横盘
- 波动：曲线来回穿越，盈亏状态反复切换

**维度2：盈亏方向**
- 盈利：曲线终点在起点之上
- 亏损：曲线终点在起点之下
- 不定：终点接近起点，或盈亏幅度相当

### 评估结果分类

| 类别 | 单调性 | 盈亏 | 分数 | 可用性 |
|------|-------|------|------|--------|
| A | 单调 | 盈利 | 5 | 直接使用 |
| B | 单调 | 亏损 | 4 | 可通过 reverse filter 反转使用 |
| C | 弱单调 | 盈利 | 3 | 基本可用，需关注 |
| D | 弱单调 | 亏损 | 3 | 可反转，需关注 |
| E | 波动 | 不定 | 1 | 只能放弃（giveup） |

**核心原则**：
- 单调盈利（5分）：最佳，直接使用
- 单调亏损（4分）：次佳，可反转后使用
- 来回波动（1分）：最差，无法使用，只能放弃

### 单调性判断标准
- **单调**：曲线从头到尾基本朝一个方向，小幅回调不超过累计幅度的30%
- **弱单调**：有明显波动，但起点到终点方向明确，回调幅度30-50%
- **波动**：曲线反复穿越零线或均值线，盈亏状态切换2次以上

### 模型综合评分
```
模型得分 = (边界切片平均分 × 0.6) + (高样本量切片平均分 × 0.4)
```
- 边界切片权重更高：反映模型核心预测能力
- 高样本量权重次之：反映模型日常稳定性

### 质量等级划分
| 等级 | 分数范围 | 建议 |
|------|---------|------|
| A | 4.0-5.0 | 优先分析，潜力模型 |
| B | 3.0-3.9 | 次优先分析 |
| C | 2.0-2.9 | 低优先级，可选分析 |
| D | 1.0-1.9 | 建议跳过或重新训练 |

## 工作流程

### 阶段1：目录扫描
1. 扫描 `temp/` 目录，获取所有模型文件夹列表
2. 按模型类型和参数分组（c/r, LAG, PRED_NEXT）
3. 统计每个模型的切片数量
4. 检测切片粒度（从文件名解析 upper - lower）

### 阶段2：并行抽样分析
1. 为每个模型确定抽样图片：
   - 按 lower 值排序，选取边界切片
   - 解析文件名提取 ratio，排序找出高样本量切片
2. 启动多个 child agents 并行处理（每个 agent 处理 2-3 个模型）
3. 每个 agent：
   - 读取抽样图片
   - 按评估标准打分（曲线向上=盈利=好）
   - 记录关键观察

### 阶段3：汇总与排序
1. 收集所有 agent 的评估结果
2. 计算每个模型的综合得分
3. 按得分降序排列
4. 划分质量等级

### 阶段4：生成报告
在项目根目录生成 `MODEL_SCREENING_REPORT.md`

## 报告格式

```markdown
# 模型快速筛选报告

生成时间：{timestamp}
扫描目录：temp/
模型总数：{count}
切片粒度：{granularity}

## 综合排名

| 排名 | 模型 | 综合得分 | 等级 | 边界得分 | 样本得分 | 建议 |
|------|------|---------|------|---------|---------|------|
| 1 | c_L5_N2 | 4.3 | A | 4.5 | 4.0 | 优先分析 |
| 2 | r_L4_N1 | 4.1 | A | 4.2 | 3.9 | 优先分析 |
| ... | ... | ... | ... | ... | ... | ... |

## 分类模型详情

### c_L4_N1 (得分: 3.8, 等级: B)

**边界切片分析**：
| 切片 | 区域 | 样本占比 | 得分 | 观察 |
|------|-----|---------|------|------|
| [0.94, 0.96] | 多头 | 2.4% | 4 | 整体上升，末端小幅回调 |
| [0.96, 0.98] | 多头 | 1.6% | 4 | 稳定上升 |
| [0.98, 1.00] | 多头 | 23.9% | 5 | 强单调上升 `[+高样本]` |
| [0.00, 0.02] | 空头 | 41.7% | 4 | 稳定上升 `[+高样本]` |
| [0.02, 0.04] | 空头 | 2.3% | 4 | 稳定上升 |
| [0.04, 0.06] | 空头 | 1.6% | 3 | 有横盘 |

**高样本量切片分析**：
| 切片 | 样本占比 | 得分 | 备注 |
|------|---------|------|------|
| [0.00, 0.02] | 41.7% | 4 | 已计入边界（空头） |
| [0.98, 1.00] | 23.9% | 5 | 已计入边界（多头） |
| [0.48, 0.50] | 15.2% | 2 | 接近阈值，方向模糊 |

**综合评价**：边界表现良好，但高样本区（阈值附近）表现一般，建议完整分析时重点校准阈值区域。

---

## 回归模型详情
...

## 建议分析顺序

### 优先分析（A级）
1. c_L5_N2 - 边界表现最佳
2. r_L4_N1 - 多空边界均稳定

### 次优先（B级）
3. c_L4_N1
4. ...

### 低优先级（C级）
...

### 建议跳过（D级）
...
```

## Child Agent Prompt 模板

```
你是模型质量评估专家。请分析以下模型的抽样切片图片。

模型信息：
- 名称：{model_name}
- 类型：{model_type} (c=分类, r=回归)
- LAG：{lag}
- PRED_NEXT：{pred_next}

**重要**：所有图片已做反转处理
- 曲线向上 = 盈利
- 曲线向下 = 亏损
- 无需考虑做多/做空方向

**双维度评估**：

维度1 - 单调性（最重要）：
- 单调：曲线整体朝一个方向，小幅回调不超过30%
- 弱单调：有波动但方向明确，回调30-50%
- 波动：来回穿越零线，盈亏状态反复切换

维度2 - 盈亏方向：
- 盈利：终点高于起点
- 亏损：终点低于起点
- 不定：终点接近起点

**评分标准**：
- 5分：单调盈利 → 直接可用
- 4分：单调亏损 → 可反转使用
- 3分：弱单调（盈利或亏损）→ 需关注
- 1分：来回波动 → 只能放弃

**核心原则**：单调性比盈亏方向更重要！
- 单调亏损（4分）优于来回波动的盈利（1分）
- 因为单调亏损可以通过 reverse filter 反转使用
- 来回波动无论盈亏都无法使用

请以JSON格式返回结果：
{
  "model": "{model_name}",
  "slices": [
    {
      "slice": "[0.00, 0.02]",
      "ratio": 0.417,
      "is_boundary": true,
      "boundary_region": "short",
      "is_high_sample": true,
      "monotonicity": "monotonic",
      "direction": "profit",
      "score": 4,
      "observation": "稳定上升，边界与高样本重叠"
    },
    {
      "slice": "[0.48, 0.50]",
      "ratio": 0.152,
      "is_boundary": false,
      "is_high_sample": true,
      "monotonicity": "volatile",
      "direction": "uncertain",
      "score": 1,
      "observation": "接近阈值，来回波动"
    },
    ...
  ],
  "boundary_avg": 4.5,
  "high_sample_avg": 3.0,
  "overall_score": 3.9,
  "volatile_count": 1,
  "summary": "边界切片表现良好（含高样本重叠），阈值附近波动需关注..."
}

**计算说明**：
- boundary_avg：所有 is_boundary=true 切片的平均分
- high_sample_avg：所有 is_high_sample=true 切片的平均分
- 重复切片同时计入两个平均分
- overall_score = boundary_avg × 0.6 + high_sample_avg × 0.4
```

## 核心要求

1. **快速筛选**：每个模型仅查看 8-11 张关键图片，不做完整分析
2. **双维度评估**：先判断单调性，再判断盈亏方向
3. **单调性优先**：单调亏损（可反转）优于来回波动（只能放弃）
4. **动态适配**：自动检测切片粒度（0.01/0.02），适配边界选取
5. **并行处理**：使用 Task tool + child agents 并行评估多个模型
6. **客观评分**：严格按照评分标准，不因模型数量多而放宽标准
7. **报告实用**：生成的报告应直接指导分析优先级决策
8. **标记波动切片**：记录 volatile_count，波动切片多的模型需谨慎
9. **完整覆盖**：确保所有 temp/ 下的模型都被评估

## 与置信度切片分析的关系

```
模型快速筛选（本SKILL）
        ↓
   生成优先级报告
        ↓
   用户决定分析顺序
        ↓
置信度切片分析（CONFIDENCE_SLICE_ANALYSIS_SKILL）
        ↓
   配置过滤器
```

本SKILL是置信度切片分析的**前置步骤**，帮助用户在大量模型中快速识别高潜力目标。
