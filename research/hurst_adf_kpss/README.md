# Hurst-ADF-KPSS 三重检验系统

适用于Jesse框架的K线趋势性三重检验分析工具，通过Hurst指数、ADF检验和KPSS检验的组合，科学判断价格序列的趋势特征。

**注意**: 本模块位于`research/`目录下，仅供线下研究分析使用，不包含`sequential`模式，不用于生产环境。

## 理论基础

### 三个核心指标

1. **Hurst指数** - 衡量时间序列的长期记忆性和趋势持续性
   - H < 0.5: 反持续性（均值回归）
   - H = 0.5: 随机游走（无趋势）
   - H > 0.5: 持续性（趋势）
   - H > 0.6: 强趋势潜力

2. **ADF检验** - 检验序列是否存在单位根（非平稳性）
   - p值 > 0.05: 非平稳（存在单位根）
   - p值 ≤ 0.05: 平稳（不存在单位根）

3. **KPSS检验** - 检验序列是否以平稳为零假设（与ADF互补）
   - p值 < 0.05: 非平稳（拒绝平稳假设）
   - p值 ≥ 0.05: 平稳（接受平稳假设）

### 深入理解三个指标

#### 1. Hurst指数 (H)

**计算方法**：使用 R/S（重标极差）分析法
- 通过计算不同时间尺度下的累积偏差范围与标准差的比值
- 对 log(R/S) 和 log(滞后期) 进行线性回归，斜率即为 Hurst 指数

**物理含义**：
- **H < 0.5**：反持续性（均值回归）
  - 价格涨后倾向于跌，跌后倾向于涨
  - 序列具有"自我修正"特性
  - 适合震荡策略（逢高卖出，逢低买入）

- **H ≈ 0.5**：随机游走
  - 价格变化完全随机，无记忆性
  - 过去走势对未来无预测价值
  - 任何策略期望收益接近零（除去交易成本）

- **H > 0.5**：持续性（趋势）
  - 价格涨后倾向于继续涨，跌后倾向于继续跌
  - 序列具有"动量"特性
  - 适合趋势跟踪策略

- **H > 0.6**：强趋势
  - 趋势持续性非常强
  - 是趋势策略的理想环境

**局限性**：
- Hurst 指数不区分上涨趋势和下跌趋势，仅衡量趋势的持续性
- 对短期噪音敏感，需要足够长的数据窗口
- 不提供平稳性信息，需要配合 ADF/KPSS 检验

#### 2. ADF检验 (Augmented Dickey-Fuller Test)

**原假设 (H0)**：序列存在单位根（非平稳）
**备择假设 (H1)**：序列不存在单位根（平稳）

**检验逻辑**：
- 通过回归方程检验序列是否有"返回均值"的趋势
- ADF 统计量越负，越倾向于拒绝原假设（即序列越平稳）
- p值表示在原假设为真的情况下，观察到当前或更极端统计量的概率

**结果解读**：
- **p值 > 0.05**：无法拒绝原假设 → 序列**非平稳**
  - 可能存在趋势、周期或单位根
  - 价格可能持续偏离均值
  - 适合趋势跟踪策略

- **p值 ≤ 0.05**：拒绝原假设 → 序列**平稳**
  - 序列围绕均值波动
  - 价格偏离后会回归
  - 适合均值回归策略

**临界值**：
- 1%: 非常强的证据拒绝原假设（强平稳）
- 5%: 较强的证据拒绝原假设（平稳）
- 10%: 弱证据拒绝原假设（弱平稳）

**局限性**：
- ADF 检验的原假设是"存在单位根"，容易犯第二类错误（假阴性）
- 对序列的平稳性判断较为保守
- 需要与 KPSS 检验互补使用

#### 3. KPSS检验 (Kwiatkowski-Phillips-Schmidt-Shin Test)

**原假设 (H0)**：序列是平稳的
**备择假设 (H1)**：序列是非平稳的

**检验逻辑**：
- 与 ADF 检验的假设相反（互补关系）
- 通过检验序列是否可以分解为"趋势+平稳误差"
- KPSS 统计量越大，越倾向于拒绝原假设（即序列越不平稳）

**结果解读**：
- **p值 < 0.05**：拒绝原假设 → 序列**非平稳**
  - 存在显著的趋势成分
  - 价格持续偏离均值
  - 适合趋势跟踪策略

- **p值 ≥ 0.05**：无法拒绝原假设 → 序列**平稳**
  - 序列围绕固定水平或线性趋势波动
  - 价格有回归倾向
  - 适合均值回归策略

**回归类型**：
- **'c'（常数）**：假设序列围绕常数均值波动
- **'ct'（常数+趋势）**：假设序列围绕线性趋势波动（本系统默认）

**局限性**：
- KPSS 的原假设是"平稳"，容易犯第一类错误（假阳性）
- 对序列的非平稳性判断较为保守
- p值计算需要插值，可能出现"p值可能更小/更大"的警告

### 指标优先级和综合判读原则

#### 三个指标的互补关系

```
Hurst 指数 ← 描述性统计（衡量特征）
    ↓
ADF 检验  ← 推断性统计（假设检验）
    ↓
KPSS 检验 ← 推断性统计（反向验证）
```

- **Hurst 指数**：定量描述趋势持续性，不涉及假设检验
- **ADF vs KPSS**：假设相反的互补检验，共同判断平稳性

#### 判读优先级

**1. 先看 Hurst 指数（H）**
- 作为初步筛选条件
- H < 0.5：倾向于震荡，优先考虑均值回归策略
- H > 0.55：倾向于趋势，进一步检查平稳性
- H ≈ 0.5：随机游走，任何策略效果有限

**2. 再看 ADF 和 KPSS 的组合**
- 两者结论一致时，结论更可靠
- 两者结论矛盾时，需要结合 Hurst 指数综合判断

**3. 综合评分作为最终决策依据**
- 评分综合了三个指标的信息
- 评分 ≥ 4：可以较为自信地使用趋势策略
- 评分 = 3：中等趋势，谨慎使用
- 评分 ≤ 2：不建议使用趋势策略

#### 常见组合模式解读

| Hurst | ADF p值 | KPSS p值 | 平稳性 | 解读 | 建议策略 |
|:-----:|:-------:|:--------:|:------:|:-----|:---------|
| > 0.55 | > 0.05 | < 0.05 | 非平稳 | **强趋势且非平稳**（三重确认） | 趋势跟踪 ⭐⭐⭐⭐⭐ |
| > 0.55 | < 0.05 | > 0.05 | 平稳 | 趋势但平稳（短期趋势） | 短期趋势/波段 ⭐⭐⭐ |
| < 0.5 | < 0.05 | > 0.05 | 平稳 | 震荡平稳 | 均值回归 ⭐⭐⭐⭐ |
| > 0.55 | > 0.05 | > 0.05 | **矛盾** | ADF非平稳 但 KPSS平稳 | 需进一步验证 ⭐⭐ |
| < 0.5 | > 0.05 | < 0.05 | **矛盾** | ADF非平稳 但 KPSS非平稳，Hurst反趋势 | 可能处于趋势转折 ⭐ |
| ≈ 0.5 | * | * | 不确定 | 随机游走 | 不建议交易 ⭐ |

#### 矛盾情况的处理

**什么是矛盾？**

矛盾主要指 ADF 和 KPSS 检验给出相反结论的情况：
- **情况 1**：ADF p值 > 0.05（非平稳）但 KPSS p值 > 0.05（平稳）
- **情况 2**：ADF p值 < 0.05（平稳）但 KPSS p值 < 0.05（非平稳）

**为什么会出现矛盾？**

1. **检验原假设相反**
   - ADF 原假设：非平稳（保守地判断平稳性）
   - KPSS 原假设：平稳（保守地判断非平稳性）
   - 当证据不够强时，两者都可能无法拒绝原假设

2. **序列处于"中间状态"**
   - 序列可能正在从平稳转向非平稳（或相反）
   - 序列可能包含复杂的动态特征（如结构突变）
   - 窗口大小不适合当前序列特征

3. **统计检验的局限性**
   - p值接近临界值时，结论不确定性增大
   - 有限样本下的统计功效不足

**如何处理矛盾情况？**

1. **结合 Hurst 指数**
   - 如果 H > 0.55，倾向于相信序列有趋势性
   - 如果 H < 0.5，倾向于相信序列是震荡的

2. **检查 p值的接近程度**
   - 如果 ADF p值 = 0.06，KPSS p值 = 0.06（都接近临界值）
     → 序列处于"临界状态"，建议谨慎对待
   - 如果某个 p值远离临界值，优先考虑该检验的结论

3. **尝试不同窗口大小**
   - 矛盾可能由窗口大小不当引起
   - 尝试更大或更小的窗口，观察结论是否趋于一致

4. **降低策略置信度**
   - 矛盾情况下的评分通常 ≤ 3
   - 建议减小仓位或不交易

**实战建议**：
- 遇到"矛盾（需进一步验证）"时，**不要强行交易**
- 优先在"强趋势且非平稳"或"震荡平稳"等明确场景下交易
- 如果必须交易，考虑使用对冲策略或降低杠杆

### 趋势类型判定

![趋势分析准则](趋势分析.png)

根据三个指标的组合，系统会自动判定以下趋势类型：

- **强趋势且非平稳（适合趋势策略）**: H>0.55, ADF_p>0.05, KPSS_p<0.05
- **趋势但平稳（短期趋势可能）**: H>0.55, ADF_p<0.05, KPSS_p>0.05
- **震荡平稳（不适合趋势策略）**: H<0.5, ADF_p<0.05, KPSS_p>0.05
- **矛盾（需进一步验证）**: H>0.55, ADF_p>0.05, KPSS_p>0.05
- **弱趋势或反趋势**: 其他情况

## 输出格式说明

从 v2.0 开始，系统提供了增强的解释性输出，包括：

### 1. 假设检验详细解释

每次分析都会输出详细的假设检验信息：

```
ADF检验[H0:存在单位根(非平稳)]: p=0.9924, 无法拒绝原假设→序列非平稳
KPSS检验[H0:序列平稳]: p=0.0100, 拒绝原假设→序列非平稳
```

- **原假设 (H0)**：明确显示每个检验的零假设
- **p值**：假设检验的显著性概率
- **结论**：是否拒绝原假设及对应的平稳性结论

### 2. Hurst指数描述性解释

Hurst 指数不仅输出数值，还包含描述性分类：

```
Hurst=0.682(强趋势持续性)
```

分类标准：
- `H > 0.6`: 强趋势持续性
- `H > 0.55`: 趋势持续性
- `H > 0.5`: 弱趋势持续性
- `H > 0.45`: 接近随机游走
- `H ≤ 0.45`: 反持续性(均值回归)

### 3. 综合趋势类型判定

输出采用结构化的多行格式，包含：

**示例1：强趋势场景**
```
【强趋势且非平稳-适合趋势策略】
  Hurst=0.682(强趋势持续性)
  ADF检验[H0:存在单位根(非平稳)]: p=0.9924, 无法拒绝原假设→序列非平稳
  KPSS检验[H0:序列平稳]: p=0.0100, 拒绝原假设→序列非平稳
  综合结论: 三重确认趋势特征，价格持续偏离均值，适合趋势跟踪
```

**示例2：矛盾场景**
```
【矛盾-需进一步验证】
  Hurst=0.660(强趋势持续性)
  ADF检验[H0:存在单位根(非平稳)]: p=0.9749, 无法拒绝原假设→序列非平稳
  KPSS检验[H0:序列平稳]: p=0.1000, 无法拒绝原假设→序列平稳
  ⚠️ 矛盾分析: ADF认为非平稳但KPSS认为平稳（两个检验结论相反）
  可能原因: (1)序列处于临界状态 (2)窗口大小不当 (3)统计功效不足
  建议: 结合Hurst(0.660)倾向于有趋势性，但需谨慎对待，建议降低仓位或尝试不同窗口
```

### 4. 快速演示

运行演示脚本查看详细输出：

```bash
python research/hurst_adf_kpss/demo_enhanced_explanation.py
```

该脚本展示了强趋势、震荡、随机游走和矛盾等多种场景的输出格式。

## 快速开始

### 1. 基本使用 - 快速趋势检查

```python
import numpy as np
from research.hurst_adf_kpss.trend_analyzer import quick_trend_check

# 加载Jesse风格K线数据
# K线格式: [timestamp, open, close, high, low, volume]
candles = np.load("data/merged_candles.npy")

# 快速检查最近60根K线的趋势
hurst, trend_type, score = quick_trend_check(candles, window=60)

print(f"Hurst指数: {hurst:.4f}")
print(f"趋势类型: {trend_type}")
print(f"趋势评分: {score}/5")

# 根据评分给出策略建议
if score >= 4:
    print("建议: 适合使用趋势跟踪策略")
elif score >= 3:
    print("建议: 部分时段可使用趋势策略")
else:
    print("建议: 不适合趋势策略，考虑震荡策略")
```

### 2. 详细分析 - 单窗口检验

```python
from research.hurst_adf_kpss.trend_analyzer import TrendAnalyzer

# 创建分析器
analyzer = TrendAnalyzer(candles)

# 分析指定窗口（如最后100根K线）
result = analyzer.analyze_window(
    start_idx=len(candles)-100,
    end_idx=len(candles)-1
)

# 查看详细结果
print(f"Hurst指数: {result['hurst']:.4f}")
print(f"ADF p值: {result['adf']['pvalue']:.4f}")
print(f"KPSS p值: {result['kpss']['pvalue']:.4f}")
print(f"趋势评分: {result['trend_score']}/5")
print(f"趋势类型: {result['trend_type']}")
print(f"使用的滞后参数: min_lag={result['min_lag']}, max_lag={result['max_lag']}")
```

### 3. 滑动窗口分析

```python
# 对多个窗口大小进行滑动分析
analyzer = TrendAnalyzer(candles)

# 分析20、40、60三个窗口，步长为10
results = analyzer.sliding_window_analysis(
    windows=[20, 40, 60],
    step=10
)

# 查看每个窗口的分析结果
for window_size, window_results in results.items():
    print(f"\n窗口大小 {window_size}:")
    print(f"  分析窗口数: {len(window_results)}")
    for i, res in enumerate(window_results[:3]):  # 显示前3个
        print(f"  窗口{i+1}: {res['trend_type']}")
```

## 高级功能

### 1. 获取统计表格

```python
# 进行滑动窗口分析后
results = analyzer.sliding_window_analysis(
    windows=[20, 40, 60],
    step=5
)

# 获取格式化的统计表格
stats_df = analyzer.get_statistics_table()
print(stats_df)

# 输出格式：
#    窗口大小  总窗口数  平均分  中位数  最高分占比  低分占比  评分标准差
# 0      60      189   2.98    3.0     26.98    46.03      1.48
# 1      40      193   2.73    3.0     13.99    44.56      1.26
# 2      20      197   2.33    2.0     10.66    55.33      1.33
```

### 2. 打印统计摘要

```python
# 打印格式化的统计摘要
analyzer.print_statistics_summary()

# 可选：保存到.md文件
analyzer.print_statistics_summary(save_to_file="statistics_summary.md")
```

输出示例：

**控制台输出（Markdown格式）：**
```markdown
# 各窗口趋势适配性评分统计

| 窗口大小 | 总窗口数 | 平均分 | 中位数 | 最高分占比 | 低分占比 | 评分标准差 |
|:--------:|:--------:|:------:|:------:|:----------:|:--------:|:----------:|
| 60 | 189 | 2.98 | 3.0 | 26.98% | 46.03% | 1.48 |
| 40 | 193 | 2.73 | 3.0 | 13.99% | 44.56% | 1.26 |
| 20 | 197 | 2.33 | 2.0 | 10.66% | 55.33% | 1.33 |

## 分析总结

- **最佳窗口大小**: 60 （平均评分 2.98）
- **最差窗口大小**: 20 （平均评分 2.33）
- **最稳定窗口**: 40 （标准差 1.26）
- **高趋势占比最高**: 60 （5分占比 27.0%）
```

保存到文件时，会自动保存为`.md`格式，并包含详细数据表格。

### 3. 导出为DataFrame

```python
# 获取完整的分析结果DataFrame
df_results = analyzer.get_results_dataframe()

# DataFrame包含以下列：
# - 窗口大小, 窗口编号, 起始索引, 结束索引
# - Hurst指数, ADF统计量, ADF p值, ADF滞后期
# - KPSS统计量, KPSS p值, KPSS警告
# - 趋势适配性评分, 趋势类型
# - min_lag, 实际max_lag
# - 起始时间戳, 结束时间戳

# 保存为CSV
df_results.to_csv("trend_analysis_results.csv", index=False)

# 筛选高评分窗口
high_score_windows = df_results[df_results['趋势适配性评分'] >= 4]
print(f"高评分窗口数: {len(high_score_windows)}")
```

### 4. 自定义滞后参数

```python
# 自定义Hurst计算的滞后参数
analyzer = TrendAnalyzer(candles)

# 使用自定义函数计算滞后参数
results = analyzer.sliding_window_analysis(
    windows=[50, 100],
    step=10,
    min_lag_func=lambda w: max(10, w // 5),  # 最小滞后为窗口的1/5
    max_lag_func=lambda w: min(50, w // 2)   # 最大滞后为窗口的1/2，但不超过50
)
```

## 趋势评分系统

系统使用0-5分的评分系统，评分规则如下：

- Hurst > 0.6: +2分
- Hurst > 0.55: +1分
- ADF p值 > 0.05（非平稳）: +1分
- KPSS p值 < 0.05（拒绝平稳）: +1分
- 三重确认奖励（同时满足上述三个条件）: +1分

评分解读：
- **5分**: 强趋势特征，非常适合趋势策略
- **4分**: 较强趋势特征，适合趋势策略
- **3分**: 中等趋势特征，部分时段适合趋势策略
- **2分**: 弱趋势特征，谨慎使用趋势策略
- **0-1分**: 无明显趋势，不适合趋势策略

## 注意事项

1. **数据要求**
   - 输入必须是Jesse风格的numpy array，shape=(n, 6)
   - 列顺序：[timestamp, open, close, high, low, volume]
   - 至少需要20个数据点进行有效分析

2. **窗口大小选择**
   - 小窗口（20-30）: 捕捉短期趋势，但噪音较大
   - 中窗口（40-60）: 平衡短期和中期趋势
   - 大窗口（80-100+）: 识别长期趋势，但反应较慢

3. **KPSS警告处理**
   - 系统会自动捕获KPSS的插值警告
   - 警告信息会显示在趋势类型描述中
   - "p值可能更小"：实际p值可能小于显示值
   - "p值可能更大"：实际p值可能大于显示值

4. **性能优化**
   - 大数据集建议增大step参数减少计算量
   - 滑动窗口分析会对每个窗口进行三重检验，计算密集
   - 可以先用快速检查函数初步判断

## 实际应用示例

### 策略集成示例

```python
def should_use_trend_strategy(candles, window=60, min_score=4):
    """
    判断当前是否应该使用趋势策略
    
    Parameters:
    -----------
    candles: Jesse K线数据
    window: 分析窗口大小
    min_score: 最低趋势评分要求
    
    Returns:
    --------
    bool: 是否使用趋势策略
    """
    hurst, trend_type, score = quick_trend_check(candles, window)
    
    if score >= min_score:
        print(f"趋势策略激活: {trend_type}")
        return True
    else:
        print(f"趋势不足: {trend_type}")
        return False

# 在Jesse策略中使用
if should_use_trend_strategy(self.candles):
    # 执行趋势跟踪逻辑
    pass
else:
    # 执行震荡或其他策略
    pass
```

### 多时间框架分析

```python
def multi_timeframe_trend_analysis(candles):
    """
    多时间框架趋势一致性分析
    """
    windows = [30, 60, 120]  # 短期、中期、长期
    scores = []
    
    for window in windows:
        if len(candles) >= window:
            _, _, score = quick_trend_check(candles, window)
            scores.append(score)
    
    # 判断趋势一致性
    if all(s >= 4 for s in scores):
        return "强趋势一致"
    elif all(s >= 3 for s in scores):
        return "中等趋势一致"
    elif any(s >= 4 for s in scores):
        return "部分时间框架有趋势"
    else:
        return "无明显趋势"
```

## 测试文件

- `test_trend_analyzer.py` - 基础功能测试
- `test_enhanced_features.py` - 增强功能测试
- `test_statistics_table.py` - 统计表格功能测试
- `test_improved_output.py` - 输出格式测试
- `demo_enhanced_explanation.py` - 增强解释性输出演示（包含假设检验详解和矛盾分析）

## 作者与维护

此工具是jesse-trade量化交易系统的一部分，专门针对Jesse框架的K线格式优化。